exp_name: bciiv2a_within_subject_cross_session_ctm_v1
seed: 42
device: auto          # auto|cpu|cuda
deterministic: true
runs_dir: runs

protocol:
  type: within_subject_cross_session
  # Train on one session of the SAME subject, test on the other session.
  # MOABB session naming depends on version; "0train"/"1test" are common for BNCI2014_001.
  train_session: "0train"
  test_session: "1test"

data:
  subjects: [1,2,3,4,5,6,7,8,9]
  sessions: null
  filterbank:
    enabled: true
    bands_hz: [[8, 13], [13, 30], [8, 30], [4, 40]]
  window:
    tmin_s: 0.0
    tmax_s: 4.0
    drop_last_sample: true
  resample_sfreq: null
  standardize:
    mode: zscore
    eps: 1.0e-6

split:
  # Validation is a stratified holdout from the TRAIN session of the same subject.
  val_strategy: within_subject
  fixed_val_subject: null
  within_subject_val_fraction: 0.3
  within_subject_stratify_by_class: true

augment:
  sr:
    enabled: true
    k_segments: 8
    cross_fade: true
    cross_fade_len: 20
    avoid_self: true
  injection:
    mode: adain        # none|concat|replace|adain|film|xattn
    replace_p: 0.5
    film_hidden: 128
    xattn_heads: 4
    xattn_dropout: 0.0
    xattn_layernorm: true

tokenizer:
  # Note: C/T are auto-overridden by `eeg_ctm.train` based on loaded data.
  # With 4-band filterbank: C = 22 * 4 = 88.
  C: 88
  T: 1000
  d_kv: 128
  temporal_kernels: [25, 63]
  F_per_branch: 8
  branch_fusion: concat
  spatial_depth_multiplier: 2
  spatial_mixer: dw_conv(C,1)
  token_pool_type: avg
  token_pool_kernel: 50
  token_stride: 50
  conv_norm: BN
  token_norm: LN
  act: ELU
  dropout_p: 0.25
  pos_emb: learnable

ctm:
  D: 256
  T_internal: 12
  M_hist: 16
  d_input: 128
  n_heads: 8
  attn_dropout: 0.0
  kv_projector: identity
  kv_mlp_hidden: 256
  synapse_hidden: 512
  synapse_dropout: 0.1
  deep_nlms: true
  memory_hidden_dims: 64
  do_layernorm_nlm: false
  nlm_dropout: 0.0
  init_mode: zeros
  ln_on_preact_hist: false
  fusion: gated
  no_decay_init: true
  head_type: linear
  head_hidden: 128
  num_classes: 4
  tick_pool_enabled: true
  tick_pool_heads: 4
  tick_pool_dropout: 0.0
  tick_pool_layernorm: true
  tick_pool_temperature: 1.0

pairs:
  D: 256
  K_action: 256
  K_out: 256
  n_self: 16
  seed: 123
  cache_name: pairs.pt

loss:
  tick_loss:
    type: mean_ce
    hybrid_lambda: 0.5
  pool_ce:
    enabled: true
    lambda_ce: 1.0

readout:
  mode: learned_attn
  certainty_weighted:
    alpha: 5.0
    detach_certainty: false

wdro:
  enabled: false
  level: rep
  norm: l2
  rho: 0.5
  steps: 3
  step_size: 0.2
  mix_robust: 1.0
  lambda_wdro: 1.0
  normalize_rep: true
  warmup_epochs: 10

opt:
  lr: 3.0e-4
  weight_decay: 1.0e-2

train:
  epochs: 200
  batch_size: 32
  num_workers: 0
  grad_clip: 1.0
  amp: false

early_stop:
  enabled: true
  patience: 20
  metric: kappa

optional:
  sampler:
    type: none
    subjects_per_batch: 4
    samples_per_class: 2
  supcon:
    enabled: false
    tau: 0.07
    lambda_con: 0.1
    proj_dim: 128
    proj_hidden: 256
    include_same_instance: true
  adversarial:
    enabled: false
    lambda_max: 0.1
    warmup: 0.3
    head_hidden: 128
  rep_agg:
    mode: certainty_weighted
    certainty_weighted:
      alpha: 5.0
      detach_certainty: false

few_shot:
  enabled: false
  protocol: cross_session
  support_session: "0train"
  query_session: "1test"
  k_shots: [1, 5, 10, 20]
  n_resamples: 5
  seed: 42
  trainable_prefixes: ["ctm.head"]
  lr: 1.0e-2
  weight_decay: 0.0
  steps: 200
  batch_size: 16
  grad_clip: null

